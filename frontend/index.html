<!DOCTYPE HTML>
<head>
  <title>DroneMap</title>
  <link rel="stylesheet" type="text/css" href="style.css"/>
</head>
<body>
<button id="sattoggle" onclick="toggleSat()">Toggle Satellite</button>
<button id="toolbutt" onclick="callSync()">Synchronize database</button>
<div id="filterMenu">
</div>
<div id="overlay">
  <button onclick="closePopup()" style="position:fixed;">Close</button>
</div>
<div id="demoMap" style="height:100vh;"></div>
<script src="openlayers/OpenLayers.js"></script>
<script>

  function callSync() {
    fetch("/api/sync")
  }

  function closePopup() {
    let el = document.getElementById("frame")
    if (el != null) el.remove()
    document.getElementById("overlay").style.display = "none"
  }

  function toggleSat() {
    isSat = !isSat
    if (isSat) {
      document.getElementById('sattoggle').innerHTML = 'Toggle Map'
      map.removeLayer(osm)
      map.addLayer(sat)
    } else {
      document.getElementById('sattoggle').innerHTML = 'Toggle Satellite'
      map.removeLayer(sat)
      map.addLayer(osm)
    }
  }

    map = new OpenLayers.Map("demoMap");
    let sat = new OpenLayers.Layer.XYZ(
                "Satellite", [
                    "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${z}/${y}/${x}"
                ], {
                    attribution: "Powered by Esri. " +
                        "Source: Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community",
                    numZoomLevels: 20,
                    sphericalMercator: true
                })
    let osm = new OpenLayers.Layer.OSM()
    map.addLayer(osm);
    let isSat = false
	  var markers = new OpenLayers.Layer.Markers( "Markers" );
    map.addLayer(markers);
	  var fromProjection = new OpenLayers.Projection("EPSG:4326");   // Transform from WGS 1984
    var toProjection   = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection

	fetch("/api/videos")
		.then(function (response) {
			return response.json()
		})
		.then(function (videos) {
			videos.forEach((video) => {
				fetch("/api/videos/" + video.id + "/datapoints")
					.then(function (res) {
						return res.json()
					})
					.then(function (points) {
            let filter = `brightness(${Math.random() * 0.75 + 1})hue-rotate(${Math.random()}turn)saturate(4)`
            let p_prev = null
						for (const p of points) {
              // If same coordinates as previous, dont draw it
              if (p_prev != null && p_prev.gps_longitude == p.gps_longitude && p_prev.gps_lattitude == p.gps_lattitude) {
                continue
              }
							marker = new OpenLayers.Marker(new OpenLayers.LonLat(p.gps_longitude + 0.00015 * Math.random(), p.gps_lattitude + 0.00015 * Math.random()).transform(fromProjection, toProjection))
              p.video = video
              marker.point = p
							marker.events.register("click", marker, function(mark) {
                closePopup()
                let overlay = document.getElementById('overlay')
                let frame = document.createElement('iframe')
                frame.src = "point.html?point=" + mark.object.point.id
                frame.style.width = "100%"
                frame.style.height = "100%"
                frame.id = "frame"
                overlay.appendChild(frame)
                overlay.style.display = "block"
							})
							markers.addMarker(marker)
              marker.inflate(0.85)
              marker.icon.imageDiv.children[0].style.filter = filter
              map.setCenter(marker.lonlat, 15)
              p_prev = p
						}
					})
			})
			if (videos.length == 0) map.zoomToMaxExtent();
		})

</script>
</body>
