<!DOCTYPE HTML>
<head>
  <title>DroneMap</title>
  <link rel="stylesheet" type="text/css" href="style.css"/>
</head>
<body>
<button id="toolbutt" onclick="callSync()">Synchronize database</button>
<div id="overlay">
  <button onclick="closePopup()">Close</button>
</div>
<div id="demoMap" style="height:98vh;"></div>
<script src="openlayers/OpenLayers.js"></script>
<script>

  function callSync() {
    fetch("http://192.168.1.33:3333/api/sync")
  }

  function closePopup() {
    let el = document.getElementById("frame")
    if (el != null) el.remove()
    document.getElementById("overlay").style.display = "none"
  }

    map = new OpenLayers.Map("demoMap");
    map.addLayer(new OpenLayers.Layer.OSM());
	  var markers = new OpenLayers.Layer.Markers( "Markers" );
    map.addLayer(markers);
	  var fromProjection = new OpenLayers.Projection("EPSG:4326");   // Transform from WGS 1984
    var toProjection   = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection

	fetch("http://192.168.1.33:3333/api/videos")
		.then(function (response) {
			return response.json()
		})
		.then(function (videos) {
			videos.forEach((video) => {
				fetch("http://192.168.1.33:3333/api/videos/" + video.id + "/datapoints")
					.then(function (res) {
						return res.json()
					})
					.then(function (points) {
						points.forEach((p) => {
							//console.log(p)
							marker = new OpenLayers.Marker(new OpenLayers.LonLat(p.gps_longitude, p.gps_lattitude).transform(fromProjection, toProjection))
							marker.id = p.id
							marker.videoId = p.video_id
							marker.time = p.start_seconds
              marker.res_width = video.resolution_width
              marker.res_height = video.resolution_height
							marker.events.register("click", marker, function(mark) {
                //window.open("point.html?point=" + mark.object.id, 'Info', 'width=1000, height=1000')
                closePopup()
                let overlay = document.getElementById('overlay')
                let frame = document.createElement('iframe')
                frame.src = "point.html?point=" + mark.object.id
                frame.style.width = "100%"
                frame.style.height = "95%"
                frame.id = "frame"
                overlay.appendChild(frame)
                overlay.style.display = "block"
							})
							markers.addMarker(marker)
              map.setCenter(marker.lonlat, 15)
						})
					})
			})
			//map.zoomToMaxExtent();
		})

</script>
</body>
